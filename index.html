<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>US States Map with Electoral Votes</title>
    <style>
      body {
        background-color: rgb(193, 233, 246);
      }

      .state {
        fill: lightgray;
        stroke: white;
        stroke-width: 1px;
      }

      .state:hover {
        fill: darkgray;
      }

      .state.highlighted {
        fill: yellow;
      }

      .vote-circle {
        fill: black;
        stroke: none;
        pointer-events: none;
      }

      .vote-circle.highlighted {
        fill: red;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script>
      const width = 960;
      const height = 600;
      const circleRadius = 2.5;
      const circlesPerRow = 4;

      const svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const projection = d3.geoAlbersUsa()
        .scale(1000)
        .translate([width / 2, height / 2]);

      const path = d3.geoPath()
        .projection(projection);

      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
        .then(topoData => {
          const states = topojson.feature(topoData, topoData.objects.states);

          const statesPaths = svg.selectAll(".state")
            .data(states.features)
            .enter()
            .append("path")
            .attr("class", "state")
            .attr("d", path);

          d3.json("electoral-college-votes.json")
            .then(electoralData => {
              states.features.forEach(state => {
                const stateData = electoralData.find(d => d.state === state.properties.name);
                if (stateData) {
                  state.properties.electoral_votes = stateData.electoral_votes;
                }
              });

              const voteCircles = svg.selectAll(".vote-circle")
                .data(states.features)
                .enter()
                .append("g")
                .attr("class", "vote-circle")
                .attr("state-name", d => d.properties.name)
                .attr("transform", d => `translate(${path.centroid(d)})`);

              voteCircles.selectAll(".vote-circle")
                .data(d => {
                  const votes = d.properties.electoral_votes;
                  const positions = [];
                  const circleSpacing = circleRadius * 4;
                  let x = -circleSpacing * 2;
                  let y = -circleSpacing * 2;
                  let row = 0;
                  let col = 0;

                  for (let i = 0; i < votes; i++) {
                    positions.push([x, y]);
                    col++;

                    if (col === circlesPerRow) {
                      col = 0;
                      row++;
                      x = -circleSpacing * 2;
                      y += circleSpacing;
                    } else {
                      x += circleSpacing;
                    }
                  }

                  return positions;
                })
                .enter()
                .append("circle")
                .attr("class", "vote-circle")
                .attr("r", circleRadius)
                .attr("cx", d => d[0])
                .attr("cy", d => d[1]);

                    // Add mouseover and mouseout event listeners after voteCircles is defined
                    statesPaths
                        .on("mouseover", function(event, d) {
                            const stateName = d.properties.name;
                            d3.select(this).classed("highlighted", true);
                            voteCircles.selectAll("circle")
                            .classed("highlighted", function() {
                                return d3.select(this.parentNode).attr("state-name") === stateName;
                            });
                        })
                        .on("mouseout", function() {
                            d3.select(this).classed("highlighted", false);
                            voteCircles.selectAll("circle")
                            .classed("highlighted", false);
                        });

            });
        });
    </script>
  </body>
</html>