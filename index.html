<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>US States Map with Electoral Votes</title>
    <style>
      body {
        background-color: rgba(218, 218, 218, 0.653);
      }

      .state {
        fill: rgb(255, 255, 255);
        stroke: rgb(213, 213, 213);
        stroke-width: 1px;
      }

      .state:hover {
        fill: darkgray;
      }

      .state.highlighted {
        fill: rgb(241, 241, 186);
      }

      .vote-circle {
        fill: black;
        stroke: none;
        pointer-events: none;
      }

      .vote-circle.highlighted {
        fill: rgb(190, 26, 255);
      }

    .state-initials {
        font-size: 12px;
        font-weight: bold;
        text-anchor: middle;
        pointer-events: none;
}
    </style>
  </head>
  <body>
    <button id="downloadButton">Download SVG</button>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script>
      const width = 960;
      const height = 600;
      const circleRadius = 2.5;
      const circlesPerRow = 4;

      const svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const projection = d3.geoAlbersUsa()
        .scale(1000)
        .translate([width / 2, height / 2]);

      const path = d3.geoPath()
        .projection(projection);

      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
        .then(topoData => {
          const states = topojson.feature(topoData, topoData.objects.states);

        d3.json("electoral-college-votes.json")
        .then(electoralData => {
            states.features.forEach(state => {
            const stateData = electoralData.find(d => d.state === state.properties.name);
            if (stateData) {
                state.properties.electoral_votes = stateData.electoral_votes;
                state.properties.postal = stateData.postal;
            }
            });

        console.log(states)

          const statesPaths = svg.selectAll(".state")
            .data(states.features)
            .enter()
            .append("path")
            .attr("class", "state")
            .attr("d", path)
            .append("title")
            .text(d => `${d.properties.name}: ${d.properties.electoral_votes} electoral votes`);

            // Add state initials
            svg.selectAll(".state-initials")
            .data(states.features)
            .enter()
            .append("text")
            .attr("class", "state-initials")
            .attr("x", d => path.centroid(d)[0])
            .attr("y", d => path.centroid(d)[1])
            .text(d => `${d.properties.postal}`);
            // .text("BB")

              const voteCircles = svg.selectAll(".vote-circle")
                .data(states.features)
                .enter()
                .append("g")
                .attr("class", "vote-circle")
                .attr("state-name", d => d.properties.name)
                .attr("transform", d => `translate(${path.centroid(d)})`);

              voteCircles.selectAll(".vote-circle")
                .data(d => {
                  const votes = d.properties.electoral_votes;
                  const positions = [];
                  const circleSpacing = circleRadius * 4;
                  let x = -circleSpacing * 2;
                  let y = -circleSpacing * 2;
                  let row = 0;
                  let col = 0;

                  for (let i = 0; i < votes; i++) {
                    positions.push([x, y]);
                    col++;

                    if (col === circlesPerRow) {
                      col = 0;
                      row++;
                      x = -circleSpacing * 2;
                      y += circleSpacing;
                    } else {
                      x += circleSpacing;
                    }
                  }

                  return positions;
                })
                .enter()
                .append("circle")
                .attr("class", "vote-circle")
                .attr("r", circleRadius)
                .attr("cx", d => d[0])
                .attr("cy", d => d[1]);

                    // Add mouseover and mouseout event listeners after voteCircles is defined
                    statesPaths
                        .on("mouseover", function(event, d) {
                            const stateName = d.properties.name;
                            d3.select(this).classed("highlighted", true);
                            voteCircles.selectAll("circle")
                            .classed("highlighted", function() {
                                return d3.select(this.parentNode).attr("state-name") === stateName;
                            });
                        })
                        .on("mouseout", function() {
                            d3.select(this).classed("highlighted", false);
                            voteCircles.selectAll("circle")
                            .classed("highlighted", false);
                        });

            });
        });

        function downloadSVG() {
            const svgElement = document.querySelector("svg");

            // Create a deep clone of the SVG element
            const clonedSvgElement = svgElement.cloneNode(true);

            // Remove the tooltip element from the cloned SVG
            const tooltipElement = clonedSvgElement.querySelector(".tooltip");
            if (tooltipElement) {
                tooltipElement.remove();
            }

            // Set the fill and stroke colors on the state paths and vote circles
            const statePaths = clonedSvgElement.querySelectorAll(".state");
            statePaths.forEach(path => {
                const fillColor = 'lightgrey';
                const strokeColor = 'darkgrey';
                path.setAttribute("fill", fillColor);
                // path.setAttribute("stroke", strokeColor);
            });

            const voteCircles = clonedSvgElement.querySelectorAll(".vote-circle circle");
            voteCircles.forEach(circle => {
                const fillColor = 'black';
                circle.setAttribute("fill", fillColor);
            });

            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(clonedSvgElement);
            const blob = new Blob([svgString], { type: "image/svg+xml" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = "us-states-map.svg";
            link.click();

            URL.revokeObjectURL(url);
            }
        const downloadButton = document.getElementById("downloadButton");
        downloadButton.addEventListener("click", downloadSVG);
    </script>
  </body>
</html>